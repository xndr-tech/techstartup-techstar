# LEVR QA Workflow v0.2.0
# Generated by LEVR CMS v0.6.3
name: QA Check

on:
  push:
    branches: [main]
    paths: ['public/**']
  pull_request:
    branches: [main]
    paths: ['public/**']
  workflow_dispatch:

jobs:
  qa:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: QA Check
        run: |
          FAILED=0
          WARNINGS=0
          
          echo "### QA Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check public directory exists
          if [ ! -d "public" ]; then
            echo "‚ùå **Error:** public/ directory not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Count files
          HTML_COUNT=$(find public -name "*.html" | wc -l)
          CSS_COUNT=$(find public -name "*.css" | wc -l)
          JS_COUNT=$(find public -name "*.js" | wc -l)
          IMG_COUNT=$(find public -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" -o -name "*.webp" -o -name "*.gif" \) | wc -l)
          TOTAL_SIZE=$(du -sh public | cut -f1)
          
          echo "#### üìÅ File Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| HTML | $HTML_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| CSS | $CSS_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | $JS_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Images | $IMG_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Size** | $TOTAL_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check each HTML file
          echo "#### üîç HTML Validation" >> $GITHUB_STEP_SUMMARY
          echo "| File | DOCTYPE | Title | Structure | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|-------|-----------|------|" >> $GITHUB_STEP_SUMMARY
          
          for html in $(find public -name "*.html"); do
            FILENAME=${html#public/}
            SIZE=$(wc -c < "$html")
            
            # DOCTYPE check
            if head -1 "$html" | grep -qi '<!doctype html>'; then
              DOCTYPE="‚úÖ"
            else
              DOCTYPE="‚ö†Ô∏è"
              WARNINGS=$((WARNINGS + 1))
            fi
            
            # Title check
            if grep -q '<title>' "$html"; then
              TITLE="‚úÖ"
            else
              TITLE="‚ùå"
              FAILED=1
            fi
            
            # Structure check
            if grep -q '</html>' "$html" && grep -q '</body>' "$html"; then
              STRUCTURE="‚úÖ"
            else
              STRUCTURE="‚ùå"
              FAILED=1
            fi
            
            # Size check
            if [ "$SIZE" -lt 500 ]; then
              SIZE_STATUS="‚ö†Ô∏è $SIZE B"
              WARNINGS=$((WARNINGS + 1))
            else
              SIZE_STATUS="‚úÖ $SIZE B"
            fi
            
            echo "| $FILENAME | $DOCTYPE | $TITLE | $STRUCTURE | $SIZE_STATUS |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check CSS files for common issues
          if [ "$CSS_COUNT" -gt 0 ]; then
            echo "#### üé® CSS Validation" >> $GITHUB_STEP_SUMMARY
            for css in $(find public -name "*.css"); do
              FILENAME=${css#public/}
              SIZE=$(wc -c < "$css")
              echo "- **$FILENAME** ($SIZE bytes)" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Summary
          if [ "$FAILED" -eq 1 ]; then
            echo "### ‚ùå QA Failed" >> $GITHUB_STEP_SUMMARY
            echo "Critical issues found. Please fix before deploying." >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$WARNINGS" -gt 0 ]; then
            echo "### ‚ö†Ô∏è QA Passed with Warnings" >> $GITHUB_STEP_SUMMARY
            echo "$WARNINGS warning(s) found." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ QA Passed" >> $GITHUB_STEP_SUMMARY
            echo "All checks passed." >> $GITHUB_STEP_SUMMARY
          fi
